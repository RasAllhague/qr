{% extends "_layout.html" %}

{% block title %}Delete QR Code{% endblock %}

{% block content %}
<div class="container qr-page">
  <h1>Delete QR Code</h1>

  <form id="delete-form" autocomplete="off">
    <div>
      <label for="id">QR Code ID</label>
      <input id="id" name="id" required />
    </div>

    <div>
      <label for="password">Password</label>
      <input id="password" name="password" type="password" required />
    </div>

    <div>
      <label for="format">Format:</label>
      <select id="format" name="format">
        <option value="png" selected>PNG</option>
        <option value="jpg">JPG</option>
        <option value="svg">SVG</option>
      </select>
    </div>

    <button type="submit" class="btn-danger">Delete</button>
  </form>

  <div id="status"></div>
  <img id="qr-image" alt="QR code" style="display:none;" />
</div>

<script>
  const form = document.getElementById('delete-form');
  const statusEl = document.getElementById('status');
  const imgEl = document.getElementById('qr-image');
  const idInput = document.getElementById('id');
  const formatInput = document.getElementById('format');

  idInput.addEventListener('change', () => {
    const id = idInput.value.trim();
    if (!id) return;
    imgEl.src = `/api/image/${encodeURIComponent(id)}?img_type=${formatInput.value}&cb=` + Date.now();
    imgEl.onload = () => imgEl.style.display = 'block';
    imgEl.onerror = () => imgEl.style.display = 'none';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusEl.textContent = 'Deletingâ€¦';
    imgEl.style.display = 'none';

    const id = idInput.value.trim();
    const password = document.getElementById('password').value;

    try {
      const res = await fetch(`/api/qr/${encodeURIComponent(id)}/${encodeURIComponent(password)}`, {
        method: 'DELETE',
        headers: { 'Accept': 'text/plain' }
      });

      if (res.status === 200) {
        statusEl.textContent = 'Deleted.';
      } else {
        const t = await res.text().catch(() => '');
        statusEl.textContent = `Delete failed: ${res.status} ${res.statusText} ${t}`;
      }
    } catch (err) {
      statusEl.textContent = 'Delete failed: ' + (err.message || String(err));
    }
  });
</script>
{% endblock %}
