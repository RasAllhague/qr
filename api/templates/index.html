{% extends "_layout.html" %}

{% block title %}QR Viewer{% endblock %}

{% block content %}
<div class="container qr-page">
  <h1>View QR Code</h1>

  <form id="view-form" autocomplete="off">
    <div>
      <label for="id">QR Code ID</label>
      <input id="id" name="id" required />
    </div>
    <div>
      <label for="format">Format:</label>
      <select id="format" name="format">
        <option value="png" selected>PNG</option>
        <option value="jpg">JPG</option>
        <option value="svg">SVG</option>
      </select>
    </div>
    <button type="submit">Show</button>
  </form>

  <div id="status"></div>
  <img id="qr-image" alt="QR code" style="display:none;" />
  <button id="download-btn" style="display:none;">Download QR Code</button>
</div>

<script>
  const form = document.getElementById('view-form');
  const statusEl = document.getElementById('status');
  const imgEl = document.getElementById('qr-image');
  const downloadBtn = document.getElementById('download-btn');
  const idInput = document.getElementById('id');
  const formatInput = document.getElementById('format');

  idInput.addEventListener('change', () => {
    if (!idInput.value.trim()) return;
    loadImage(idInput.value.trim(), formatInput.value);
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    loadImage(idInput.value.trim(), formatInput.value);
  });

  function loadImage(id, format) {
    statusEl.textContent = 'Loadingâ€¦';
    imgEl.style.display = 'none';
    downloadBtn.style.display = 'none';
    imgEl.removeAttribute('src');

    imgEl.src = `/api/image/${encodeURIComponent(id)}?img_type=${format}&cb=` + Date.now();

    imgEl.onload = () => {
      imgEl.style.display = 'block';
      downloadBtn.style.display = 'inline-block';
      statusEl.textContent = `QR loaded (id: ${id})`;
    };
    imgEl.onerror = () => {
      statusEl.textContent = 'Not found or failed to load image.';
      imgEl.style.display = 'none';
    };
  }

  downloadBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.href = imgEl.src;
    link.download = 'qr-code.' + formatInput.value;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
</script>
{% endblock %}
